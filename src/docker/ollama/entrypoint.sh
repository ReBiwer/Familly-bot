#!/bin/bash

# Entrypoint —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ Ollama
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏:
# 1. –ó–∞–ø—É—Å–∫–∞–µ—Ç Ollama —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
# 2. –û–∂–∏–¥–∞–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ API
# 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª—å, —É–∫–∞–∑–∞–Ω–Ω—É—é –≤ OLLAMA_MODEL
# 4. –í—ã–≤–æ–¥–∏—Ç –ª–æ–≥–∏ —Ä–∞–±–æ—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ Ollama —Å–µ—Ä–≤–µ—Ä–∞..."
# –ó–∞–ø—É—Å–∫–∞–µ–º Ollama –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
# nohup –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞
# & –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –≤ —Ñ–æ–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º
nohup ollama serve > /var/log/ollama.log 2>&1 &

# –°–æ—Ö—Ä–∞–Ω—è–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞ Ollama –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
OLLAMA_PID=$!

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Ollama API (PID: $OLLAMA_PID)..."
# –ñ–¥–µ–º, –ø–æ–∫–∞ API —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–º
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–∞–Ω–¥—É ollama list –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç curl)
MAX_RETRIES=30
RETRY_COUNT=0

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É ollama list
    # –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —É—Å–ø–µ—à–Ω–æ, –∑–Ω–∞—á–∏—Ç API –≥–æ—Ç–æ–≤
    if ollama list > /dev/null 2>&1; then
        echo "‚úÖ Ollama API –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!"
        break
    fi
    
    RETRY_COUNT=$((RETRY_COUNT + 1))
    if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
        echo "‚ùå –û—à–∏–±–∫–∞: Ollama API –Ω–µ —Å—Ç–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω –∑–∞ –æ—Ç–≤–µ–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è"
        echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ Ollama:"
        tail -n 50 /var/log/ollama.log
        exit 1
    fi
    
    echo "  –ü–æ–ø—ã—Ç–∫–∞ $RETRY_COUNT/$MAX_RETRIES..."
    sleep 2
done

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∫–∞–∑–∞–Ω–∞ –ª–∏ –º–æ–¥–µ–ª—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
if [ -n "$LLM__OLLAMA_MODEL" ]; then

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π.
    # ollama list –≤—ã–≤–æ–¥–∏—Ç —Ç–∞–±–ª–∏—Ü—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –ø–æ—ç—Ç–æ–º—É tail -n +2 –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É,
    # –∞ awk '{print $1}' –±–µ—Ä—ë—Ç —Ç–æ–ª—å–∫–æ –∏–º—è –º–æ–¥–µ–ª–∏ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞.
    EXISTING_MODELS=$(ollama list | tail -n +2 | awk '{print $1}')

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω—É–∂–Ω–∞—è –º–æ–¥–µ–ª—å —Å—Ä–µ–¥–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö.
    # grep -qxF –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–æ—á–Ω–æ–µ (Fixed-string, full-line) —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ,
    # —á—Ç–æ–±—ã "gemma" –Ω–µ —Å–æ–≤–ø–∞–ª–∞ —Å "gemma2" –∏–ª–∏ "gemma:7b-instruct".
    TARGET_ALREADY_INSTALLED=false
    if [ -n "$EXISTING_MODELS" ]; then
        if echo "$EXISTING_MODELS" | grep -qxF "$LLM__OLLAMA_MODEL"; then
            TARGET_ALREADY_INSTALLED=true
        fi
    fi

    if [ "$TARGET_ALREADY_INSTALLED" = true ]; then
        echo "‚úÖ –ú–æ–¥–µ–ª—å $LLM__OLLAMA_MODEL —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."

        # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ ¬´–ª–∏—à–Ω–∏–µ¬ª –º–æ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —Ü–µ–ª–µ–≤–æ–π,
        # —á—Ç–æ–±—ã –Ω–µ –∑–∞–Ω–∏–º–∞—Ç—å –º–µ—Å—Ç–æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º–∏ –≤–µ—Å–∞–º–∏.
        STALE_MODELS=$(echo "$EXISTING_MODELS" | grep -vxF "$LLM__OLLAMA_MODEL" || true)
        if [ -n "$STALE_MODELS" ]; then
            echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π..."
            for model in $STALE_MODELS; do
                echo "  –£–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏: $model"
                ollama rm "$model" || echo "  ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å $model, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            done
            echo "‚úÖ –õ–∏—à–Ω–∏–µ –º–æ–¥–µ–ª–∏ —É–¥–∞–ª–µ–Ω—ã"
        fi
    else
        # –¶–µ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –∏ —Å–∫–∞—á–∏–≤–∞–µ–º –Ω—É–∂–Ω—É—é.
        if [ -n "$EXISTING_MODELS" ]; then
            echo "üóëÔ∏è  –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å $LLM__OLLAMA_MODEL, —É–¥–∞–ª—è–µ–º..."
            for model in $EXISTING_MODELS; do
                echo "  –£–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏: $model"
                ollama rm "$model" || echo "  ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å $model, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            done
            echo "‚úÖ –°—Ç–∞—Ä—ã–µ –º–æ–¥–µ–ª–∏ —É–¥–∞–ª–µ–Ω—ã"
        fi

        echo "üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: $LLM__OLLAMA_MODEL"

        if ollama pull "$LLM__OLLAMA_MODEL"; then
            echo "‚úÖ –ú–æ–¥–µ–ª—å $LLM__OLLAMA_MODEL —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!"

            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏..."
            if ollama list | grep -q "$LLM__OLLAMA_MODEL"; then
                echo "‚úÖ –ú–æ–¥–µ–ª—å $LLM__OLLAMA_MODEL –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π"
            else
                echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ"
            fi
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏ $LLM__OLLAMA_MODEL"
            echo "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∏–º–µ–Ω–∏ –º–æ–¥–µ–ª–∏ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Ollama Registry"
            exit 1
        fi
    fi
else
    echo "‚ö†Ô∏è  –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è LLM__OLLAMA_MODEL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ú–æ–¥–µ–ª—å –Ω–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
    echo "üí° –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å –≤—Ä—É—á–Ω—É—é: ollama pull <model_name>"
fi

echo "üéâ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! Ollama —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é."
echo "üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏:"
ollama list

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏ Ollama –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
# –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏–¥–µ—Ç—å —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ docker logs
echo "üìù –í—ã–≤–æ–¥ –ª–æ–≥–æ–≤ Ollama..."
tail -f /var/log/ollama.log
